<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat System Test Client</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      text-align: center;
    }

    .header h1 {
      margin-bottom: 10px;
    }

    .status {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
      margin-top: 10px;
    }

    .status.connected {
      background: #10b981;
    }

    .status.disconnected {
      background: #ef4444;
    }

    .content {
      padding: 25px;
    }

    .section {
      margin-bottom: 25px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
    }

    .section h3 {
      color: #334155;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }

    .section h3::before {
      content: '';
      width: 4px;
      height: 20px;
      background: #667eea;
      margin-right: 10px;
      border-radius: 2px;
    }

    .input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    input, select {
      flex: 1;
      min-width: 150px;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    select {
      flex: 0 0 150px;
      cursor: pointer;
      background: white;
    }

    input[type="file"] {
      flex: 1;
      padding: 8px;
      border: 2px dashed #e2e8f0;
      cursor: pointer;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }

    button {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    #messages {
      height: 350px;
      overflow-y: auto;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      background: white;
    }

    .message {
      padding: 12px;
      margin-bottom: 10px;
      background: white;
      border-left: 4px solid #667eea;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 12px;
    }

    .message-sender {
      font-weight: 600;
      color: #667eea;
    }

    .message-time {
      color: #94a3b8;
    }

    .message-text {
      color: #334155;
      line-height: 1.5;
    }

    .alert {
      padding: 12px;
      border-radius: 8px;
      margin-top: 10px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .alert.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }

    .alert.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }

    .empty-state {
      text-align: center;
      color: #94a3b8;
      padding: 40px;
    }

    #messageInput {
      flex: 3;
    }

    .file-preview {
      margin-top: 10px;
      padding: 10px;
      background: #f8fafc;
      border-radius: 8px;
      display: none;
    }

    .file-preview.show {
      display: block;
    }

    .file-preview img {
      max-width: 200px;
      max-height: 200px;
      border-radius: 4px;
      margin-top: 5px;
    }

    .file-info {
      font-size: 12px;
      color: #64748b;
      margin-top: 5px;
    }

    .btn-upload {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .user-badge {
      display: inline-block;
      padding: 4px 10px;
      background: #ddd6fe;
      color: #5b21b6;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üí¨ Chat System Test Client</h1>
      <p>Real-time messaging with Socket.IO</p>
      <div class="status disconnected" id="connectionStatus">
        ‚ö´ Disconnected
      </div>
    </div>

    <div class="content">
      <div class="section">
        <h3>1Ô∏è‚É£ Join Chat Room</h3>
        <div class="input-group">
          <input type="text" id="chatId" placeholder="Chat ID (e.g., CHAT_123456)" value="">
          <input type="text" id="userId" placeholder="User ID" value="100">
          <button onclick="joinRoom()">üö™ Join Room</button>
        </div>
        <div id="joinStatus"></div>
      </div>

      <div class="section">
        <h3>2Ô∏è‚É£ Send Message</h3>
        <div class="input-group">
          <select id="messageType" onchange="handleTypeChange()">
            <option value="text">üìù Text</option>
            <option value="image">üñºÔ∏è Image</option>
            <option value="video">üé• Video</option>
            <option value="document">üìÑ Document</option>
            <option value="location">üìç Location</option>
            <option value="audio">üéµ Audio</option>
          </select>
          <input type="text" id="messageInput" placeholder="Type your message here..." 
                 onkeypress="if(event.key==='Enter') sendMessage()">
          <input type="file" id="fileInput" style="display:none;" onchange="handleFileSelect()" 
                 accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.txt,.zip,audio/*">
          <button onclick="sendMessage()">üì§ Send</button>
        </div>
        <div id="filePreview" class="file-preview">
          <div id="previewContent"></div>
          <div id="fileInfo" class="file-info"></div>
        </div>
      </div>

      <div class="section">
        <h3>3Ô∏è‚É£ Messages <span class="user-badge" id="currentUserBadge"></span></h3>
        <div id="messages">
          <div class="empty-state">
            <p>üëã No messages yet</p>
            <p style="font-size: 14px; margin-top: 10px;">Join a room and start chatting!</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script>
    const socket = io('http://localhost:3000');
    let currentChatId = '';
    let currentUserId = '';
    let hasMessages = false;

    socket.on('connect', () => {
      console.log('‚úì Connected to server');
      updateConnectionStatus(true);
    });

    socket.on('disconnect', () => {
      console.log('‚úó Disconnected from server');
      updateConnectionStatus(false);
    });

    function updateConnectionStatus(isConnected) {
      const statusEl = document.getElementById('connectionStatus');
      if (isConnected) {
        statusEl.className = 'status connected';
        statusEl.textContent = 'üü¢ Connected';
      } else {
        statusEl.className = 'status disconnected';
        statusEl.textContent = '‚ö´ Disconnected';
      }
    }

    function joinRoom() {
      currentChatId = document.getElementById('chatId').value.trim();
      currentUserId = document.getElementById('userId').value.trim();

      if (!currentChatId || !currentUserId) {
        showAlert('joinStatus', 'Please enter both Chat ID and User ID', 'error');
        return;
      }

      socket.emit('joinChatRoom', {
        chatId: currentChatId,
        userId: currentUserId
      });

      socket.once('joinChatRoom', (response) => {
        console.log('Join response:', response);
        if (response.success) {
          showAlert('joinStatus', `‚úì Successfully joined room ${currentChatId}`, 'success');
          document.getElementById('currentUserBadge').textContent = `User ${currentUserId}`;
          clearMessages();
        } else {
          showAlert('joinStatus', `‚úó Error: ${response.error}`, 'error');
        }
      });
    }

    function sendMessage() {
      const messageText = document.getElementById('messageInput').value.trim();
      const messageType = document.getElementById('messageType').value;
      
      if (!currentChatId || !currentUserId) {
        alert('‚ö†Ô∏è Please join a room first');
        return;
      }

      // Build message payload
      const payload = {
        chatId: currentChatId,
        senderId: currentUserId,
        type: messageType
      };

      // For text or location messages
      if (messageType === 'text' || messageType === 'location') {
        if (!messageText) {
          alert('‚ö†Ô∏è Please enter a message');
          return;
        }
        payload.message = messageText;
      }
      // For file-based messages
      else if (['image', 'video', 'document', 'audio'].includes(messageType)) {
        if (!uploadedFileData) {
          alert('‚ö†Ô∏è Please upload a file first');
          return;
        }
        payload.file_url = uploadedFileData.url;
        payload.file_name = uploadedFileData.name;
        payload.file_size = uploadedFileData.size;
        payload.mime_type = uploadedFileData.mime_type;
        if (messageText) {
          payload.message = messageText; // Optional caption
        }
      }

      socket.emit('sendMessage', payload);

      // Clear inputs
      document.getElementById('messageInput').value = '';
      document.getElementById('fileInput').value = '';
      document.getElementById('filePreview').classList.remove('show');
      uploadedFileData = null;
    }

    socket.on('sendMessage', (response) => {
      console.log('Send response:', response);
      if (!response.success) {
        alert('‚ùå Error sending message: ' + response.error);
      }
    });

    socket.on('receiveMessage', (message) => {
      console.log('üì© Received message:', message);
      displayMessage(message);
    });

    function displayMessage(message) {
      const messagesDiv = document.getElementById('messages');
      
      // Remove empty state if it exists
      if (!hasMessages) {
        messagesDiv.innerHTML = '';
        hasMessages = true;
      }

      const messageElement = document.createElement('div');
      messageElement.className = 'message';
      
      const isOwnMessage = message.senderId === currentUserId;
      if (isOwnMessage) {
        messageElement.style.borderLeftColor = '#10b981';
      }

      const time = new Date(message.timestamp).toLocaleTimeString();
      
      // Get type icon
      const typeIcons = {
        text: 'üìù',
        image: 'üñºÔ∏è',
        video: 'üé•',
        document: 'üìÑ',
        location: 'üìç',
        audio: 'üéµ'
      };
      const typeIcon = typeIcons[message.type] || 'üìù';
      
      let contentHtml = '';
      
      // Handle different message types
      if (message.type === 'text') {
        contentHtml = `<div class="message-text">${escapeHtml(message.message)}</div>`;
      } else if (message.type === 'image') {
        contentHtml = `
          <img src="${message.file_url}" alt="${message.file_name}" style="max-width: 300px; border-radius: 8px; margin-top: 5px; cursor: pointer;" onclick="window.open('${message.file_url}', '_blank')">
          ${message.message ? `<div class="message-text">${escapeHtml(message.message)}</div>` : ''}
          <div style="font-size: 11px; color: #94a3b8; margin-top: 3px;">${message.file_name} (${formatFileSize(message.file_size)})</div>
        `;
      } else if (message.type === 'video') {
        contentHtml = `
          <video controls style="max-width: 300px; border-radius: 8px; margin-top: 5px;">
            <source src="${message.file_url}" type="${message.mime_type}">
          </video>
          ${message.message ? `<div class="message-text">${escapeHtml(message.message)}</div>` : ''}
          <div style="font-size: 11px; color: #94a3b8; margin-top: 3px;">${message.file_name} (${formatFileSize(message.file_size)})</div>
        `;
      } else if (message.type === 'document' || message.type === 'audio') {
        contentHtml = `
          <a href="${message.file_url}" target="_blank" style="color: #667eea; text-decoration: none;">
            üìé ${message.file_name}
          </a>
          ${message.message ? `<div class="message-text">${escapeHtml(message.message)}</div>` : ''}
          <div style="font-size: 11px; color: #94a3b8; margin-top: 3px;">${formatFileSize(message.file_size)}</div>
        `;
      } else if (message.type === 'location') {
        contentHtml = `<div class="message-text">üìç ${escapeHtml(message.message)}</div>`;
      }
      
      messageElement.innerHTML = `
        <div class="message-header">
          <span class="message-sender">
            ${typeIcon} ${isOwnMessage ? 'üë§ You' : 'üë§ User ' + message.senderId}
          </span>
          <span class="message-time">${time}</span>
        </div>
        ${contentHtml}
      `;
      
      messagesDiv.appendChild(messageElement);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      // Add a subtle notification sound effect (optional)
      if (!isOwnMessage) {
        playNotificationSound();
      }
    }

    function clearMessages() {
      const messagesDiv = document.getElementById('messages');
      messagesDiv.innerHTML = '<div class="empty-state"><p>üëã Room joined! Start chatting!</p></div>';
      hasMessages = false;
    }

    function showAlert(elementId, message, type) {
      const alertEl = document.createElement('div');
      alertEl.className = `alert ${type}`;
      alertEl.textContent = message;
      
      const container = document.getElementById(elementId);
      container.innerHTML = '';
      container.appendChild(alertEl);
      
      setTimeout(() => {
        alertEl.style.opacity = '0';
        setTimeout(() => alertEl.remove(), 300);
      }, 5000);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatFileSize(bytes) {
      if (!bytes) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    let uploadedFileData = null;

    function handleTypeChange() {
      const type = document.getElementById('messageType').value;
      const fileInput = document.getElementById('fileInput');
      const messageInput = document.getElementById('messageInput');
      const filePreview = document.getElementById('filePreview');
      
      if (['image', 'video', 'document', 'audio'].includes(type)) {
        fileInput.style.display = 'block';
        messageInput.placeholder = 'Optional caption...';
      } else {
        fileInput.style.display = 'none';
        fileInput.value = '';
        messageInput.placeholder = 'Type your message here...';
        filePreview.classList.remove('show');
        uploadedFileData = null;
      }
    }

    async function handleFileSelect() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      
      if (!file) return;
      
      const previewDiv = document.getElementById('filePreview');
      const previewContent = document.getElementById('previewContent');
      const fileInfo = document.getElementById('fileInfo');
      
      // Show preview
      previewDiv.classList.add('show');
      fileInfo.innerHTML = `üìé ${file.name} (${formatFileSize(file.size)})<br><span style="color: #667eea;">‚è≥ Uploading...</span>`;
      
      // Upload file
      try {
        const formData = new FormData();
        formData.append('file', file);
        
        const response = await fetch('http://localhost:3000/api/upload', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
          uploadedFileData = result;
          
          // Show preview based on type
          const type = document.getElementById('messageType').value;
          if (type === 'image') {
            previewContent.innerHTML = `<img src="${result.url}" alt="Preview" style="max-width: 200px; border-radius: 8px;">`;
          } else if (type === 'video') {
            previewContent.innerHTML = `<video src="${result.url}" controls style="max-width: 200px; border-radius: 8px;"></video>`;
          } else {
            previewContent.innerHTML = `<div style="color: #10b981;">‚úì File ready</div>`;
          }
          
          fileInfo.innerHTML = `‚úÖ ${result.name} (${formatFileSize(result.size)})<br><span style="color: #10b981;">Ready to send!</span>`;
        } else {
          fileInfo.innerHTML = `‚ùå Upload failed: ${result.error}`;
          uploadedFileData = null;
        }
      } catch (error) {
        fileInfo.innerHTML = `‚ùå Upload error: ${error.message}`;
        uploadedFileData = null;
      }
    }

    function playNotificationSound() {
      // Create a simple beep sound using Web Audio API
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
      } catch (e) {
        // Silently fail if audio is not supported
      }
    }

    // Auto-focus message input when page loads
    window.onload = () => {
      document.getElementById('chatId').focus();
    };
  </script>
</body>
</html>
